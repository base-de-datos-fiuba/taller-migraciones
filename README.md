# Usemos alembic!:

1. Actualicemos una tabla existente, por ejemplo, la tabla `users` para agregar un nuevo campo `age`:

```python
# models.py
from sqlalchemy import Table, Column, String, MetaData, Integer

metadata = MetaData()

users = Table(
    "users",
    metadata,
    Column("email", String, primary_key=True, nullable=False),
    Column('name', String, nullable=False),
    Column('age', Integer, nullable=True)  # Nuevo campo age
)
```

2. Generamos una nueva migración con Alembic:

```bash
alembic revision --autogenerate -m "Add age"
```

Esto nos va a generar un nuevo archivo de migración en la carpeta `versions` con el nombre `<id>_add_age.py`.

3. Verificamos el contenido del archivo de migración generado. Debería verse algo así:

```python
"""Add age

Revision ID: 088debcb9f01
Revises: 64fec890be11
Create Date: 2025-06-12 13:35:11.268707

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = '088debcb9f01'
down_revision: Union[str, None] = '64fec890be11'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column('users', sa.Column('age', sa.Integer(), nullable=True))
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_column('users', 'age')
    # ### end Alembic commands ###
```
Hay que verificar que los pasos de `upgrade` y `downgrade` sean correctos.

4. Aplicamos la migración a la base de datos:

```bash
alembic upgrade head
```
Esto nos tiene que tirar un output del estilo:
```
INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.
INFO  [alembic.runtime.migration] Will assume transactional DDL.
INFO  [alembic.runtime.migration] Running upgrade 64fec890be11 -> 088debcb9f01, Add age
```
5. Verificamos que la columna `age` se haya agregado correctamente a la tabla `users` en la base de datos.

```bash
docker exec -it <container_name> psql -U salud -d usuarios -c "\d users"
```

```
                    Table "public.users"
 Column |       Type        | Collation | Nullable | Default
--------+-------------------+-----------+----------+---------
 email  | character varying |           | not null |
 name   | character varying |           | not null |
 age    | integer           |           |          |
Indexes:
    "users_pkey" PRIMARY KEY, btree (email)
```

6. Mientras desarrollamos, nos damos cuenta que además del campo `age`, es mejor agregar un campo `birthdate` para almacenar la fecha de nacimiento del usuario. Ademas, queremos agregar un campo `is_active` para indicar si el usuario está activo o no. Actualizamos el modelo `users`:

```python
# models.py
from sqlalchemy import Table, Column, String, MetaData, Integer, Date

metadata = MetaData()

users = Table(
    "users",
    metadata,
    Column("email", String, primary_key=True, nullable=False),
    Column('name', String, nullable=False),
    Column('birthdate', Date, nullable=True),  # Nuevo campo birthdate de tipo Date
    Column('is_active', Integer, default=1)  # Nuevo campo is_active
)
```

Qué hacemos con la migración que generamos anteriormente?

Hay varias opciones, pero tengamos en cuenta que cuando terminemos, solo queremos tener una nueva version que representa todos los cambios del PR o de la feature:
- Podemos eliminar la migración anterior y generar una nueva migración con todos los cambios. (Primero debemos hacer un `downgrade` a la migración anterior para que no haya problemas al eliminarla).
- Podemos modificar la migración anterior para que incluya los nuevos cambios. (Recomendado).

(No se olviden de modificar el modelo `users` además de la migración)

7. Modifiquemos la migración.

Primero hagamos downgrade a la migración anterior:

```bash
alembic downgrade <id de la version objetivo>
```

o mas facil:

```bash
alembic downgrade -1
```

Ahora, abrimos el archivo de migración generado anteriormente y lo modificamos para que incluya los nuevos cambios:

```python
"""Add age, birthdate and is_active
Revision ID: 088debcb9f01
Revises: 64fec890be11
Create Date: 2025-06-12 13:35:11.268707

"""
from typing import Sequence, Union
from alembic import op
import sqlalchemy as sa
# revision identifiers, used by Alembic.
revision: str = '088debcb9f01'
down_revision: Union[str, None] = '64fec890be11'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None

def upgrade() -> None:
    op.add_column('users', sa.Column('birthdate', sa.Date(), nullable=True))
    op.add_column('users', sa.Column('is_active', sa.Integer(), nullable=False, server_default='1'))

def downgrade() -> None:
    op.drop_column('users', 'is_active')
    op.drop_column('users', 'birthdate')
```

8. Hacemos el upgrade head:

```bash
alembic upgrade head
```

y si verificamos la tabla `users` nuevamente:
```
                      Table "public.users"
  Column   |       Type        | Collation | Nullable | Default
-----------+-------------------+-----------+----------+---------
 email     | character varying |           | not null |
 name      | character varying |           | not null |
 birthdate | date              |           |          |
 is_active | integer           |           | not null | 1
Indexes:
    "users_pkey" PRIMARY KEY, btree (email)
```
